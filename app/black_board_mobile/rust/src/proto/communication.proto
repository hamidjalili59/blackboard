syntax = "proto3";

package communication;

// ===================================================================
// پیام‌های کلاینت به سرور (Client to Server)
// ===================================================================

message ClientToServer {
  oneof payload {
    InitialRequest initial_request = 1;
    RoomMessage room_message = 2;
  }
}

message InitialRequest {
    oneof request_type {
        CreateRoomRequest create_room = 1;
        JoinRoomRequest join_room = 2;
        ReplayRoomRequest replay_room = 3;
        ListRecordingsRequest list_recordings = 4;
    }
}

message ListRecordingsRequest {}

message CreateRoomRequest {
    string username = 1;
}

message JoinRoomRequest {
    string room_id = 1;
    string username = 2;
}

message ReplayRoomRequest {
    string log_filename = 1;
}

message RoomMessage {
  oneof payload {
    CanvasCommand canvas_command = 1;
    AudioChunk audio_chunk = 2;
  }
}

message Point {
    float dx = 1;
    float dy = 2;
}

message PathStart {
    uint64 path_id = 1;
    Point point = 2;
    uint32 color = 3;
    float stroke_width = 4;
}

message PathAppend {
    uint64 path_id = 1;
    Point point = 2;
}

message PathEnd {
    uint64 path_id = 1;
}

message PathFull {
    uint64 path_id = 1;
    repeated Point points = 2;
    uint32 color = 3;
    float stroke_width = 4;
}

message CanvasCommand {
  int64 timestamp_ms = 1;
  oneof command_type {
    PathStart path_start = 2;
    PathAppend path_append = 3;
    PathEnd path_end = 4; // PathFull حذف و PathEnd اضافه شد
  }
}

message AudioChunk {
  bytes data = 1;
  int64 sequence = 2;
}


// ===================================================================
// پیام‌های سرور به کلاینت (Server to Client)
// ===================================================================

message ServerToClient {
    oneof payload {
        InitialResponse initial_response = 1;
        RoomEvent room_event = 2;
    }
}

message InitialResponse {
    oneof response_type {
        CreateRoomResponse create_room_response = 1;
        JoinRoomResponse join_room_response = 2;
        ErrorResponse error_response = 3;
        ListRecordingsResponse list_recordings_response = 4;
    }
}

message ListRecordingsResponse {
    repeated string filenames = 1;
}

// برای سادگی کلاینت، سرور participant_id را مستقیم ارسال می‌کند
message CreateRoomResponse {
    string room_id = 1;
    uint32 participant_id = 2;
}

message CanvasSnapshot {
    repeated PathFull paths = 1;
}

message JoinRoomResponse {
    string message = 1;
    uint32 participant_id = 2;
    optional CanvasSnapshot initial_canvas_state = 3;
}

message ErrorResponse {
    string message = 1;
}

message RoomEvent {
    oneof event_type {
        UserJoined user_joined = 1;
        UserLeft user_left = 2;
        BroadcastedCanvasCommand canvas_command = 3;
        BroadcastedAudioChunk audio_chunk = 4;
        HostEndedSession host_ended_session = 5;
        CanvasSnapshot canvas_snapshot = 6;
    }
}

message HostEndedSession {
    string message = 1;
}

message UserJoined {
    uint32 participant_id = 1;
    string username = 2;
    string client_id_uuid = 3; // برای لاگ کردن یا دیباگ
}

message UserLeft {
    uint32 participant_id = 1;
    string username = 2;
}

message BroadcastedCanvasCommand {
    uint32 from_participant_id = 1;
    CanvasCommand command = 2;
}

message BroadcastedAudioChunk {
    uint32 from_participant_id = 1;
    AudioChunk chunk = 2;
}
